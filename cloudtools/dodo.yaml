backdrops:
  cloudtools: &cloudtools
    image:
      name: dodo/cloudtools
      requires: [dodo/base, dodo/languages/golang]
      context: '{{ currentDir }}'
      dockerfile: '{{ currentDir }}/Dockerfile'
    volumes:
      - 'awsconfig:/home/dodo/.aws'
      - 'sshconfig:/home/dodo/.ssh'
      - 'kubeconfig:/home/dodo/.kube'
      - '{{ projectRoot }}:/build'
    working_dir: '/build/{{ projectPath }}'

  aws:
    <<: *cloudtools
    script: exec aws "$@"

  terraform:
    <<: *cloudtools
    environment:
      - TF_LOG=DEBUG
      - TF_LOG_PATH=/build/terraform.log
      - TF_VAR_username=ole.claussen.api
    script: |
      test -f terraform.log && rm -f terraform.log
      exec terraform "$@"
    command: apply

  tfsec:
    <<: *cloudtools
    script: exec tfsec "$@"

  packer:
    <<: *cloudtools
    script: exec packer "$@"

  ansible:
    <<: *cloudtools
    environment:
      - ANSIBLE_HOST_KEY_CHECKING=False
    script: |
      eval $(ssh-agent)
      ssh-add
      ansible-playbook "$@"

  render:
    <<: *cloudtools
    script: exec render "$@"
