backdrops:
  gpg:
    image:
      name: dodo/gpg
      requires: [dodo/languages/buildbase, dodo/base]
      context: '{{ currentDir }}'
      dockerfile: '{{ currentDir }}/Dockerfile'
    volumes:
      - 'gpg-data:/data/gpg'
    environment:
      - 'GNUPGHOME=/data/gpg'
    script: exec gpg "$@"

  unlock:
    container_name: gpg-agent
    image:
      name: dodo/gpg
      requires: [dodo/languages/buildbase, dodo/base]
      context: '{{ currentDir }}'
      dockerfile: '{{ currentDir }}/Dockerfile'
    volumes:
      - '/dev/bus/usb:/dev/bus/usb'
      - 'scd:/var/run/pcscd'
      - 'gpg-data:/data/gpg'
    environment:
      - 'GNUPGHOME=/data/gpg'
    devices:
      - cgroup_rule: 'c *:* rmw'
    script: |
      /init/configure.sh
      /init/unlock.sh

  ykman:
    image:
      name: dodo/gpg
      requires: [dodo/languages/buildbase, dodo/base]
      context: '{{ currentDir }}'
      dockerfile: '{{ currentDir }}/Dockerfile'
    volumes:
      - '/dev/bus/usb:/dev/bus/usb'
      - 'scd:/var/run/pcscd'
    devices:
      - cgroup_rule: 'c *:* rmw'
    script: |
      set -eux
      rm -f /var/run/pcscd/*
      pcscd
      exec ykman "$@"
