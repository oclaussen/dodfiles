backdrops:
  session:
    stage: wabe
    forward_stage: true
    image:
      name: dodo/session
      requires: [dodo/base, dodo/languages/buildbase, dodo/languages/rust, dodo/languages/ruby]
      context: '{{ currentDir }}'
      dockerfile: '{{ currentDir }}/Dockerfile'
    environment:
      - 'TMUX_TMPDIR=/data/tmux'
    volumes:
      - 'tmux-data:/data/tmux'
      - 'zsh-data:/data/zsh'
      - 'vim-data:/data/vim'
      - '/Users:/Users'
    script: |
      tmuxinator start default
      PID=$(tmux display-message -pF '#{pid}')
      tail --pid="${PID}" -f /dev/null

  tmux-client:
    aliases: tmux
    stage: wabe
    image:
      name: dodo/tmux
      requires: [dodo/base, dodo/languages/buildbase]
      context: '{{ currentDir }}'
      dockerfile: '{{ currentDir }}/Dockerfile.client'
    volumes: 'tmux-data:/data/tmux'
    environment: 'TMUX_TMPDIR=/data/tmux'
    user: dodo
    script: |
      if [ $# != 0 ]; then
        exec tmux "$@"
      else
        exec tmux -2 attach -t default
      fi
